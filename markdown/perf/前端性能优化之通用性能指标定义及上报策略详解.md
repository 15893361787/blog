# 前端性能优化之通用性能指标定义及上报策略详解
## 背景
性能优化是所有前端人的追求，在这条路上，方法多种多样。这篇文章，说一下利用浏览器的一些API，可以怎样进行自定义性能指标及上报。

## 指标
### FP
#### 含义
FP，全称 `First Paint`，翻译为`首次绘制`,是时间线上的第一个`时间点`，它代表网页的第一个像素渲染到屏幕上所用时间，也就是页面在屏幕上首次发生视觉变化的时间。

#### 统计逻辑
通过performance.getEntriesByType('paint’)，取第一个pain的时间。如：
```js
function getFPTime(){
    const timings = performance.getEntriesByType('paint')[0];
    return timings ? Math.round(timings.startTime) : null
} 
```
### FCP
#### 含义
FCP，全称 `First Contentful Paint`，翻译为`首次内容绘制`，顾名思义，它代表浏览器第一次向屏幕绘`内容`。

注意：只有首次绘制文本、图片（包含背景图）、非白色的canvas或SVG时才被算作FCP。
#### 统计逻辑
通过performance.getEntriesByType('paint’)，取第二个pain的时间，或者通过Mutation Observer观察到首次节点变动的时间。如：
```js
const domEntries = []
const observer = new MutationObserver((mutationsList)=>{
    for(var mutation of mutationsList) {
        if (mutation.type == 'childList') {
            console.log('A child node has been added or removed.');
        }
        if (mutation.type == 'addedNodes') {
            //TODO新增了节点，做处理，计算此时的可见性/位置/出现时间等信息，然后 push 进数组
            ...
            domEntries.push(mutation) 
        }
    }
});

function getFPTime(){
    const timings = performance.getEntriesByType('paint');
    if(timings.length > 1)return timings[1]
    return timings ? Math.round(timings.startTime) : null
    //伪代码,算 DOM 变化时的最小那个时间，即节点首次变动的时间
    return Math.round(domEntries.length ? Math.min(...domEntries.map(entry => entry.time)) : 0);
} 
```
`MutationObserver` 理解及使用补充: 
+ https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver
+ https://javascript.ruanyifeng.com/dom/mutationobserver.html

#### 注意
FP与FCP这两个指标之间的主要区别是：FP是当浏览器开始绘制内容到屏幕上的时候，只要在视觉上开始发生变化，无论是什么内容触发的视觉变化，在这一刻，这个时间点，叫做FP。

相比之下，FCP指的是浏览器首次绘制来自DOM的内容。例如：文本，图片，SVG，canvas元素等，这个时间点叫FCP。

FP和FCP可能是相同的时间，也可能是先FP后FCP。

### FMP
#### 含义
FMP，全称 `First Meaningful Paint`，翻译为`首次有意义的绘制`，是页面主要内容出现在屏幕上的时间, 这是用户感知加载体验的主要指标。目前尚无标准化的定义, 因为很难以通用的方式去确定各种类型页面的关键内容。
#### 统计逻辑
目前没有统一逻辑，阿里有个标准为最高可见增量元素，采用深度优先遍历方法，详细可见：https://zhuanlan.zhihu.com/p/44933789

其次，可以自定义，比如通 Mutation Observer 观察页面加载的一段时间(如前20s)内页面节点的变化, 即元素新增/移除/隐藏等变化记录下来，这样可以得到页面元素的可见时间点及元素与可视区域的交叉信息等。

然后，自定义一个计算公式，比如根据元素的类型进行权重取值(div 权重1，img 权重2等), 然后取元素与可视区域的交叉区域面积、可见度、 权重值之间的乘积为元素评分。

根据上面得到的信息, 以时间点为X轴, 该时间点可见元素的评分总和为Y轴, 取最高点对应的最小时间为页面主要内容出现在屏幕上的时间。

### FID
#### 含义
FID，全称 `First Input Delay`，翻译为`首次输入延迟`，是测量用户首次与您的站点交互时的时间（即当他们单击链接/点击按钮/使用自定义的JavaScript驱动控件时）到浏览器实际能够回应这种互动的时间。
#### 统计逻辑
方式一，通过`performanceObserver`(目前支持性	88.78%)观察类型为`first-input`的entry，获得其startTime/duration等数即可

### 参考资料
+ https://www.w3.org/TR/DOM-Level-3-Events/#events-mutationevents